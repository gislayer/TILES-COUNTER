const pointInPolygon = require('@turf/boolean-point-in-polygon');
const BBox = require('@turf/bbox');
const intersect = require('@turf/boolean-intersects');

class TilesCounter {

  constructor(polygon){
    this.area = polygon;
    this.status=false;
    try{
      if(this.checker()){
        this.status=true;
      }
    }catch(error){
      console.error('Error :', error.message);
    }
  }

  checker(){
    this.isCorrectType();
    this.isGeoJSON();
    return true;
  }

  isCorrectType(){
    if(typeof this.area !== 'object'){
      throw new Error('Polygon parameter is not an object!');
    }
  }

  isGeoJSON(){
    if(this.area['type']==undefined){
      throw new Error('Polygon type is not valid!');
    }
    if(this.area['geometry']==undefined){
      throw new Error('Polygon geometry is not valid!');
    }
    if(this.area.geometry['type']!=='Polygon'){
      throw new Error('GeoJSON is not a Polygon!');
    }
    if(this.area.geometry.coordinates==undefined){
      throw new Error('Polygon coordinates are not valid!');
    }
    if(this.area.geometry.coordinates.length!==1){
      throw new Error('Polygon coordinates are not a ring!');
    }
    if(this.area.geometry.coordinates[0].length<4){
      throw new Error('Polygon must have 3 coordinates!');
    }
  }

  getMiddleFrom2Coord(latlng1,latlng2){
    return [(latlng1[0]+latlng2[0])/2,(latlng1[1]+latlng2[1])/2];
  }

  checkTileInPolygon(tile){
    var p1 = this.tile2LatLong(tile);
    var p2 = this.tile2LatLong(this.getRightTile(tile));
    var p3 = this.tile2LatLong(this.getRightTile(this.getBottomTile(tile)));
    var p4 = this.tile2LatLong(this.getBottomTile(tile));
    var line = {type:'Feature',properties:{},geometry:{type:'LineString',coordinates:[p1,p2,p3,p4]}};
    var point = this.getMiddleFrom2Coord(p1,p3);
    var intersects = intersect.default(line,this.area);
    var inpolygon = pointInPolygon.default(point,this.area);
    if(intersects || inpolygon){
      return true;
    }else{
      return false;
    }
  }

  getTilesAtZoom(zoom){
    if(this.status==false){
      return [];
    }
    var bbox = BBox.default(this.area);
    var LT_tile = this.latLong2tile([bbox[0],bbox[3]],zoom);
    var RB_tile = this.latLong2tile([bbox[2],bbox[1]],zoom);
    if(LT_tile.x==RB_tile.x && LT_tile.y==RB_tile.y){
      return [LT_tile];
    }
    var tiles = [];
    for(var x=LT_tile.x;x<=RB_tile.x;x++){
      for(var y=LT_tile.y;y<=RB_tile.y;y++){
        var tile = {x:x,y:y,z:zoom};
        if(this.checkTileInPolygon(tile)){
          tiles.push(tile);
        }
      }
    }
    return tiles;
  }

  getTilesFromZoomRange(minZoom, maxZoom){
    var tileset = {};
    var tilesCount = 0;
    for(var z=minZoom;z<=maxZoom;z++){
      var tile = this.getTilesAtZoom(z);
      tilesCount+=tile.length;
      tileset[z] = tile;
    }
    return {count:tilesCount,zoom:tileset};
  }

  getRightTile(tile){
    return {
      x:tile.x+1,
      y:tile.y,
      z:tile.z
    }
  }

  getBottomTile(tile){
    return {
      x:tile.x,
      y:tile.y+1,
      z:tile.z
    }
  }

  latLong2tile(coord,z){
    var xtile = Math.floor((coord[0] + 180) / 360 * Math.pow(2, z));
    var ytile = Math.floor((1 - Math.log(Math.tan(coord[1] * Math.PI / 180) + 1 / Math.cos(coord[1] * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, z));
    return {
      x: xtile,
      y: ytile,
      z: z
    };
  }

  tile2LatLong(tile){
    var {x,y,z} = tile;
    var n = Math.PI - 2 * Math.PI * y / Math.pow(2, z);
    var lng = x / Math.pow(2, z) * 360 - 180;
    var lat = 180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n)));
    return [lng, lat];
  }
} 

var p = { "type": "Feature", "geometry": { "type": "Polygon", "coordinates": [ [ [ 27.079925, 38.466089 ], [ 27.1091, 38.4889 ], [ 27.181205, 38.489741 ], [ 27.226181, 38.473616 ], [ 27.2303, 38.44 ], [ 27.19802, 38.41338 ], [ 27.15888, 38.40127 ], [ 27.11631, 38.4109 ], [ 27.1444, 38.4470 ], [ 27.1656, 38.447 ], [ 27.16026, 38.46286 ], [ 27.13554, 38.46232 ], [ 27.1115, 38.4453 ], [ 27.07649, 38.46259 ], [ 27.079925, 38.466089 ] ] ] }, "properties": {} };
var t = 'https://mts1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}';

var p1 = { "type": "Feature", "geometry": { "type": "Polygon", "coordinates": [ [ [ 49.919357633174315, 40.58026540933756 ], [ 49.92041443764357, 40.574100716600185 ], [ 49.923355876749675, 40.56196507861159 ], [ 49.91483098736433, 40.55995715012 ], [ 49.9146372398783, 40.55976340263396 ], [ 49.917332091274915, 40.559604881963566 ], [ 49.92081954602346, 40.55882989201942 ], [ 49.92354962423571, 40.55775547414237 ], [ 49.925469485688204, 40.55685719034349 ], [ 49.928710352727244, 40.55347541604189 ], [ 49.92989045105125, 40.5514674875503 ], [ 49.9321097404367, 40.54260794341633 ], [ 49.932567689040035, 40.540300586991805 ], [ 49.93406482870482, 40.53348419816507 ], [ 49.93549151473832, 40.52841153671264 ], [ 49.936988654403095, 40.5253468037518 ], [ 49.939630665576246, 40.52083777134965 ], [ 49.94288914602312, 40.51664578028823 ], [ 49.944580033173935, 40.51412706296989 ], [ 49.94649989462643, 40.51208390766266 ], [ 49.9511850611068, 40.50637716352861 ], [ 49.955799773955896, 40.5011107545902 ], [ 49.95660999071566, 40.50019485738349 ], [ 49.960396873397166, 40.495914799282986 ], [ 49.960907662223974, 40.495139809338866 ], [ 49.96691383429093, 40.49843351660138 ], [ 49.9699961806596, 40.50012440375218 ], [ 49.97251489797799, 40.50329481716 ], [ 49.97598473931872, 40.50192097134993 ], [ 49.980352864458325, 40.50109314118234 ], [ 49.9805422085924, 40.50096104062368 ], [ 49.98087245998904, 40.4993670272159 ], [ 49.981268761665014, 40.497834660735464 ], [ 49.98154176948624, 40.49660172218799 ], [ 49.98255454043595, 40.49688794006508 ], [ 49.98321063987728, 40.496940780288554 ], [ 49.984219007475026, 40.49656649537235 ], [ 49.985293425352104, 40.49654007526061 ], [ 49.9855796432292, 40.49658851213212 ], [ 49.98584824769848, 40.49663694900363 ], [ 49.98611244881578, 40.49737671213214 ], [ 49.98642068345265, 40.497297451796925 ], [ 49.98695789239118, 40.49649604174107 ], [ 49.988014696860446, 40.49630229425506 ], [ 49.988666392949824, 40.496284680847225 ], [ 49.99130840412297, 40.495914799282986 ], [ 49.99408251585478, 40.495544917718775 ], [ 49.995870276748605, 40.49528952330536 ], [ 50.00395483093842, 40.49728864509305 ], [ 50.00892181194393, 40.498477550120896 ], [ 50.01609927563097, 40.50033576464605 ], [ 50.02328554602193, 40.50187693783036 ], [ 50.0350248823346, 40.50593682833312 ], [ 50.039084772837334, 40.50500331771863 ], [ 50.050515874513145, 40.50228204621027 ], [ 50.051167570602516, 40.50266073447841 ], [ 50.0544348577533, 40.502634314366674 ], [ 50.056081711384564, 40.50279283503707 ], [ 50.05830100077001, 40.50337407749515 ], [ 50.05830100077001, 40.50337407749515 ], [ 50.05836264769738, 40.5038144126907 ], [ 50.061744421999, 40.503224363528716 ], [ 50.06471228121684, 40.50691437246721 ], [ 50.071053108032395, 40.51039302051183 ], [ 50.074540562780946, 40.510146432802316 ], [ 50.08460662535062, 40.510481087550914 ], [ 50.084932473395305, 40.510516314366555 ], [ 50.10096067451237, 40.50981177805372 ], [ 50.102404973953696, 40.50958280375207 ], [ 50.10485323764081, 40.50323317023259 ], [ 50.10540805998716, 40.50253744062368 ], [ 50.10555777395364, 40.50262550766277 ], [ 50.11075372926082, 40.494637827215996 ], [ 50.1157735504898, 40.487055255149045 ], [ 50.118688569484156, 40.48231724844521 ], [ 50.11864453596461, 40.480899369115605 ], [ 50.11684796836688, 40.479278935596085 ], [ 50.11252387674681, 40.47672499146205 ], [ 50.110357427584844, 40.475448019395 ], [ 50.11389772255686, 40.471872497607336 ], [ 50.11390652926077, 40.471872497607336 ], [ 50.11793999965178, 40.46754840598729 ], [ 50.122818913618175, 40.46259903838967 ], [ 50.1247651951824, 40.46059110989805 ], [ 50.125654672277356, 40.459772086434384 ], [ 50.1288074722773, 40.45871528196511 ], [ 50.133483832053784, 40.4580019389484 ], [ 50.139084895740844, 40.45739427637855 ], [ 50.142017528143036, 40.45668093336181 ], [ 50.14412233037764, 40.455791456266866 ], [ 50.160326665572924, 40.44961795682559 ], [ 50.165505007472284, 40.447610028334 ], [ 50.175377322555946, 40.444827109898284 ], [ 50.176830428701166, 40.44414899369718 ], [ 50.17705059629892, 40.444016893138496 ], [ 50.17864460970672, 40.44312741604355 ], [ 50.18217609797483, 40.439349340065945 ], [ 50.18390221194128, 40.43714766408834 ], [ 50.18480049574015, 40.436064439507334 ], [ 50.18729279294682, 40.43315822721689 ], [ 50.18871947898032, 40.43142330654652 ], [ 50.189124587360205, 40.43135285291524 ], [ 50.191026835404855, 40.43027843503816 ], [ 50.19163449797468, 40.43009349425603 ], [ 50.19330777171768, 40.42892220263593 ], [ 50.20740730467838, 40.415712146770204 ], [ 50.212506386242545, 40.415817827217126 ], [ 50.214170853281615, 40.415958734479716 ], [ 50.21336063652186, 40.42668529984266 ], [ 50.21407397953861, 40.4257077557086 ], [ 50.21476970914754, 40.42446601045725 ], [ 50.216222815292774, 40.42266944285953 ], [ 50.216337302443605, 40.42192967973102 ], [ 50.218494944901686, 40.420450153474036 ], [ 50.22004492478992, 40.41952544956345 ], [ 50.220758267806666, 40.42010669202156 ], [ 50.22118979629828, 40.42040611995452 ], [ 50.225020712499344, 40.41748229425622 ], [ 50.22653546557194, 40.416390262971305 ], [ 50.230102180655685, 40.4136249579434 ], [ 50.23214533596292, 40.412876388111016 ], [ 50.23577369797404, 40.411484928893174 ], [ 50.236073125907, 40.41433830096017 ], [ 50.24222901194042, 40.4189089802897 ], [ 50.247072699091184, 40.415069257384715 ], [ 50.248737166130255, 40.41612606185399 ], [ 50.25764955048768, 40.40843780934014 ], [ 50.261101778420574, 40.410445737831765 ], [ 50.26310090020826, 40.414637728893126 ], [ 50.26310090020826, 40.41468176241267 ], [ 50.26310090020826, 40.41468176241267 ], [ 50.26508240858812, 40.4187416529154 ], [ 50.271458462219314, 40.41748229425622 ], [ 50.28533782758223, 40.41233917917248 ], [ 50.29760556612954, 40.40647391436812 ], [ 50.29636382087815, 40.402933619396094 ], [ 50.30323304992834, 40.40026518811118 ], [ 50.30325066333616, 40.39985127302742 ], [ 50.30760998177185, 40.3938362942566 ], [ 50.308746046576296, 40.39319340487111 ], [ 50.309758817525996, 40.392594549005196 ], [ 50.31197810691144, 40.39487548531804 ], [ 50.314223816408614, 40.396108423865485 ], [ 50.32108423875488, 40.39652233894927 ], [ 50.32644752143636, 40.39642546520628 ], [ 50.330111110263125, 40.39813396576491 ], [ 50.33351049797256, 40.398812081966014 ], [ 50.33715647339151, 40.400916884200626 ], [ 50.33950786333562, 40.40216743615588 ], [ 50.32691427674362, 40.411379248446224 ], [ 50.31963993931356, 40.4160468015188 ], [ 50.31918199071023, 40.418019503194756 ], [ 50.312365601883506, 40.42108423615562 ], [ 50.29660160188375, 40.42769807079239 ], [ 50.29011106110172, 40.43797549425591 ], [ 50.28991731361569, 40.44606004844573 ], [ 50.27248884657684, 40.4530261512389 ], [ 50.2638758901524, 40.45823091325002 ], [ 50.25602031026424, 40.46296891995391 ], [ 50.249626643225234, 40.468561176937044 ], [ 50.24809427674481, 40.47485797023302 ], [ 50.24260770020858, 40.48274877693677 ], [ 50.240555738197436, 40.48815609313786 ], [ 50.23343992143777, 40.49578269872433 ], [ 50.23185471473388, 40.501225241741 ], [ 50.226808473393184, 40.504941670791226 ], [ 50.10031778512692, 40.548552468555926 ], [ 50.07326359071393, 40.59646093782894 ], [ 49.981673870044915, 40.60378811548247 ], [ 49.91939285998998, 40.58062648419789 ], [ 49.91939285998998, 40.58062648419789 ], [ 49.91941928010171, 40.580732164644814 ], [ 49.91941928010171, 40.580732164644814 ], [ 49.91941928010171, 40.580732164644814 ], [ 49.919357633174315, 40.58026540933756 ] ] ] }, "properties": { "geotype": "MultiPolygon", "index": 1 } };
var a = new TilesCounter(p1);
var tiles = a.getTilesFromZoomRange(0,18);
console.log(tiles); 